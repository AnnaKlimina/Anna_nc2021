function getDate(){let e=new Date;return e.getDate()+" "+["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"][e.getMonth()]+", "+e.getFullYear()}function changeAddButton(e,t){let o=document.querySelector(".book-content__button[data-button-task]");o.dataset.buttonTask=e,o.textContent=t}async function addComment(e,t,o){let r,n=await fetch("https://my-library-project-server.herokuapp.com/get_avatar?login="+e);if(!n.ok)return void alert(n.status);r=await n.json();let a=document.querySelector(".comment-block__comment-container"),c=tmplComment.content.cloneNode(!0);a.append(c),c=a.querySelector(".comment-block__comment:last-of-type"),c.querySelector(".comment-block__comment-author-avatar").src=r,c.querySelector(".comment-block__comment-author-avatar").onerror=()=>{c.querySelector(".comment-block__comment-author-avatar").src="https://my-library-project-server.herokuapp.com/defaultUserAvatar.png"},c.querySelector(".content__header-author").textContent=e,c.querySelector(".content__header-date").textContent=t,c.querySelector(".content__main").textContent=o}async function createCurrentBookPage(e,t){let o,r=await fetch("https://my-library-project-server.herokuapp.com/book_page?book_name="+e+"&book_author="+t);if(!r.ok)return void alert(r.status);o=await r.json(),o=o[0];let n=document.querySelector(".main-page");n.innerHTML="",n.dataset.currentPage="current-book-page";let a=tmplCurrentBook.content.cloneNode(!0);n.append(a),a=n.querySelector(".book-content"),a.dataset.book=e+","+t;let c=a.querySelector(".book-genre-list");for(let e of o.genreList){let t=document.createElement("li");t.className="book-genre-list__item",t.textContent=e,c.append(t)}if(a.querySelector(".book-content__picture").style.backgroundImage="url("+o.img+")",a.querySelector(".book-header__name").textContent=o.bookName,a.querySelector(".book-header__author").textContent=o.bookAuthor,a.querySelector(".book-content__content").textContent=o.bookContent,"authorized"===document.querySelector(".authorization-block").dataset.userState){let e;if(r=await fetch("https://my-library-project-server.herokuapp.com/check_book?book="+o.bookName+","+o.bookAuthor+"&login="+document.querySelector(".authorization-block__user-login")?.textContent),!r.ok)return void alert(r.status);e=await r.json(),e&&changeAddButton("deleteFromUserLibrary","Удалить из библиотеки")}a.querySelector(".book-content__button[data-button-task]").addEventListener("click",(async function(o){switch(o.target.dataset.buttonTask){case"addToUserLibrary":if("authorized"===document.querySelector(".authorization-block").dataset.userState){let o={login:document.querySelector(".authorization-block__user-login").textContent,book:e+","+t};await fetch("https://my-library-project-server.herokuapp.com/add_to_user_library",{method:"POST",mode:"cors",dataType:"json",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(o)});changeAddButton("deleteFromUserLibrary","Удалить из библиотеки")}else showAnnouncement("Составлять свою библиотеку могут только авторизированные пользователи",o);break;case"deleteFromUserLibrary":let r={login:document.querySelector(".authorization-block__user-login").textContent,book:e+","+t};await fetch("https://my-library-project-server.herokuapp.com/delete_from_user_library",{method:"POST",mode:"cors",dataType:"json",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(r)});changeAddButton("addToUserLibrary","Добавить в библиотеку")}}));let u=o.comments;for(let e=0;e<u.length;e++)addComment(u[e].commentAuthor,u[e].addDate,u[e].commentContent);document.querySelector(".comment-block__button").addEventListener("click",(async function(o){let r=document.querySelector(".comment-block__textarea").value;if(document.querySelector(".comment-block__textarea").value="Введите комментарий",!r||0==+r)return;if("unauthorized"===document.querySelector(".authorization-block").dataset.userState)return void showAnnouncement("Комментарии могут оставлять только авторизированные пользователи нашего сайта.",o);let n=getDate();addComment(document.querySelector(".authorization-block__user-login").textContent,n,r);let a={bookName:e,bookAuthor:t,img:document.querySelector(".authorization-block__icon").style.backgroundImage.match(/url\(\"(.+)\"\)/)[1],commentAuthor:document.querySelector(".authorization-block__user-login").textContent,addDate:n,commentContent:r};await fetch("https://my-library-project-server.herokuapp.com/add_comment",{method:"POST",mode:"cors",dataType:"json",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(a)})}))}