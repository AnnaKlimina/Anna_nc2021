function getDate(){let e=new Date;return e.getDate()+" "+["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"][e.getMonth()]+", "+e.getFullYear()}function changeAddButton(e,t){let o=document.querySelector(".book-content__button[data-button-task]");o.dataset.buttonTask=e,o.textContent=t}function addComment(e,t,o,n){let r=document.querySelector(".comment-block__comment-container"),a=tmplComment.content.cloneNode(!0);r.append(a),a=r.querySelector(".comment-block__comment:last-of-type"),a.querySelector(".comment-block__comment-author-avatar").style.backgroundImage="url("+e+")",a.querySelector(".content__header-author").textContent=t,a.querySelector(".content__header-date").textContent=o,a.querySelector(".content__main").textContent=n}async function createCurrentBookPage(e,t){let o,n=await fetch("https://my-library-project-server.herokuapp.com/book_page?book_name="+e+"&book_author="+t);if(!n.ok)return void alert(n.status);o=await n.json(),o=o[0];let r=document.querySelector(".main-page");r.innerHTML="",r.dataset.currentPage="current-book-page";let a=tmplCurrentBook.content.cloneNode(!0);r.append(a),a=r.querySelector(".book-content"),a.dataset.book=e+","+t;let c=a.querySelector(".book-genre-list");for(let e of o.genreList){let t=document.createElement("li");t.className="book-genre-list__item",t.textContent=e,c.append(t)}if(a.querySelector(".book-content__picture").style.backgroundImage="url("+o.img+")",a.querySelector(".book-header__name").textContent=o.bookName,a.querySelector(".book-header__author").textContent=o.bookAuthor,a.querySelector(".book-content__content").textContent=o.bookContent,"authorized"===document.querySelector(".authorization-block").dataset.userState){let e;if(n=await fetch("https://my-library-project-server.herokuapp.com/check_book?book="+o.bookName+","+o.bookAuthor+"&login="+document.querySelector(".authorization-block__user-login")?.textContent),!n.ok)return void alert(n.status);e=await n.json(),e&&changeAddButton("deleteFromUserLibrary","Удалить из библиотеки")}a.querySelector(".book-content__button[data-button-task]").addEventListener("click",(async function(o){switch(o.target.dataset.buttonTask){case"addToUserLibrary":if("authorized"===document.querySelector(".authorization-block").dataset.userState){let o={login:document.querySelector(".authorization-block__user-login").textContent,book:e+","+t};await fetch("https://my-library-project-server.herokuapp.com/add_to_user_library",{method:"POST",mode:"cors",dataType:"json",headers:{Accept:"application/json"},body:JSON.stringify(o)});changeAddButton("deleteFromUserLibrary","Удалить из библиотеки")}else showAnnouncement("Составлять свою библиотеку могут только авторизированные пользователи",o);break;case"deleteFromUserLibrary":let n={login:document.querySelector(".authorization-block__user-login").textContent,book:e+","+t};await fetch("https://my-library-project-server.herokuapp.com/delete_from_user_library",{method:"POST",mode:"cors",dataType:"json",headers:{Accept:"application/json"},body:JSON.stringify(n)});changeAddButton("addToUserLibrary","Добавить в библиотеку")}}));let u=o.comments;for(let e=0;e<u.length;e++)addComment(u[e].img,u[e].commentAuthor,u[e].addDate,u[e].commentContent);document.querySelector(".comment-block__button").addEventListener("click",(async function(o){let n=document.querySelector(".comment-block__textarea").value;if(document.querySelector(".comment-block__textarea").value="Введите комментарий",!n||0==+n)return;if("unauthorized"===document.querySelector(".authorization-block").dataset.userState)return void showAnnouncement("Комментарии могут оставлять только авторизированные пользователи нашего сайта.",o);let r=getDate();addComment(document.querySelector(".authorization-block__icon").style.backgroundImage.match(/url\(\"(.+)\"\)/)[1],document.querySelector(".authorization-block__user-login").textContent,r,n);let a={bookName:e,bookAuthor:t,img:document.querySelector(".authorization-block__icon").style.backgroundImage.match(/url\(\"(.+)\"\)/)[1],commentAuthor:document.querySelector(".authorization-block__user-login").textContent,addDate:r,commentContent:n};await fetch("https://my-library-project-server.herokuapp.com/add_comment",{method:"POST",mode:"cors",dataType:"json",headers:{Accept:"application/json"},body:JSON.stringify(a)})}))}